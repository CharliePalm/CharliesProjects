<!DOCTYPE html>
<script src='/socket.io/socket.io.js'></script>
<script>
const socket = io.connect();
  socket.emit('newPlayer');
</script>
<style type="text/css">
html , body {
  background: #212121;
  color: #fff;
  margin: 0;
  padding: 0;
}
#canvas {
  position: absolute;
  left: 0; right: 0; top: 0; bottom: 0;
  margin: auto;
}


</style>
<body>

<h1 id='top'>Waiting for players!</h1>
  <p1 id='sub'>Currently we have:</p1>
  <p2 id='nameLabel'></p2>
  <p3 id="names"></p3>
  <p4><br>
    <button id ='everyone' onClick="gameStart()">Everyone&apos;s in</button>
  </p4>

<h2>You are:</h2>
  <p3 id='id'></p3>

<div1 id='second'>
  <p id='postChoice'></p>
</div1>

<p id='vote'></p>

<div2 id='pres'>
  <p id='cpick'></p>
</div2>

<div3 id='parentOfChoice'>
  <p id='choice'></p>
</div3>

<h5 id='cards'></h5>
  <p1 id='card1'></p1>
  <p1 id='card2'></p1>
  <p1 id='card3'></p1>

<h6 id='fascists'>
  <p1 id='f'></p1>
</h6>

<h7 id='liberals'>
  <p1 id='l'></p1>
</h7>

<h8 id='powerAction'></h7>
</body>
<script>

  // initializes the primary game view
  socket.on('gamestart', function(players, id, firstID) {
    document.getElementById('f').innerHTML = 'Fascists played:<br>';
    document.getElementById('l').innerHTML = 'Liberals played:';
    var elem = document.getElementById('everyone');
    elem.parentNode.removeChild(elem);
    var bool = false;
    var callID;
    for (var key in players) {
      callID = key;
      break;
    }
    document.getElement
    document.getElementById('top').innerHTML = "Your super secret role is:";
    document.getElementById('nameLabel').innerHTML = '<br><br>Current Players:';

    if (players[socket.id].isHitler) {
      // when there's only 5 or 6 players hitler know his fascists
      if (Object.keys(players).length == 5 || Object.keys(players).length == 6) {
        var otherFasc = "";
        for (var key in players) {
          if (players[key].isFascist) {
              otherFasc = players[key].name;
              break;
            }
          }
        document.getElementById('sub').innerHTML = "HITLER. Your other fascist is " + otherFasc;
      } else {
        document.getElementById('sub').innerHTML = "HITLER";
      }
    } else if (players[socket.id].isFascist) {
      var otherFascists = "";
      var moreFasc = false;
      for (var key in players) {
        var hitler;
        if (players[key].isFascist) {
          if (players[key].isHitler) {
            hitler = players[key].name;
          } else {
            moreFasc = true;
            otherFascists += players[key].name + " and ";
          }
        }
      }
      if (!moreFasc) {
        document.getElementById('sub').innerHTML = "FASCIST. Your only ally is HITLER who is " + hitler + "";
      } else {
        document.getElementById('sub').innerHTML = "FASCIST. Your other Fascists are " + otherFascists + "HITLER is " + hitler + "";
      }
    } else {
      document.getElementById('sub').innerHTML = "LIBERAL";
    }
    // adds lines between names and role
    document.getElementById('names').innerHTML = "<br><br><br>"

    for (var key in players) {
      if (key == socket.id) {
        continue;
      } else {
        document.getElementById('names').innerHTML += players[key].name + "<br><br>";
      }
    }
    if (firstID == socket.id) {
      socket.emit('newpres', true);
      bool = false;
    }
    bool = false;
  });

  socket.on('newpres', function(pres, players, first, game) {
    destroyChoice();
    destroyPostChoice();
    destroyCards();
    if (socket.id == pres.id) {
      if (first) {
        document.getElementById('pres').innerHTML = "You have been selected to be the first President!";
      } else {
        document.getElementById('pres').innerHTML = "You are the new President!<br>";
      }
      document.getElementById('choice').innerHTML = 'Pick your chanecellor:<br>';
      for (key in players) {
        let i = key;
        const id = key;
        if (key == socket.id) {
          continue;
        } else {
          var x = document.createElement("BUTTON");
          var t = document.createTextNode(players[key].name);
          x.append(t);
          x.addEventListener('click', function() {
            chancellor(id, game);
          })
          var element = document.getElementById('choice');
          element.append(x);
        }
      }
    } else {
      if (first) {
      document.getElementById('pres').innerHTML = "The first President is " + pres.name + ". They are currently deciding on their Chancellor.";
    } else {
      document.getElementById('pres').innerHTML = "The new President is " + pres.name + ". They are currently deciding on their Chancellor.";
    }
    }
  });

  socket.on('vote', function(currChance, game) {
    destroyI();
    destroyPostChoice();
    if (!(socket.id in game.players)) {
      return;
    }
    document.getElementById('pres').innerHTML = game.currPres.name + ' has chosen ' + currChance.name + ' to be Chancellor. ja or nein?<br>';
    document.getElementById('pres').innerHTML += "Remember: this vote is final!";
    var x = document.createElement("BUTTON");
    var t = document.createTextNode("nein!");
    x.append(t);
    x.addEventListener('click', function() {
      destroyChoice();
      document.getElementById('choice').innerHTML = 'you voted nein!';
      socket.emit('nein');
    })
    var element = document.getElementById('choice');
    element.append(x);

    var x = document.createElement("BUTTON");
    var t = document.createTextNode("ja!");
    x.append(t);
    x.addEventListener('click', function() {
      destroyChoice();
      document.getElementById('choice').innerHTML = 'you voted ja!';
      socket.emit('ja', currChance.id);
    })

    var element = document.getElementById('choice');
    element.append(x);
  });

  socket.on('kill', function(game, dead) {
    destroyPostChoice();
    document.getElementById('powerAction').innerHTML = game.currPres.name + ' has killed ' + dead.name + ". They were a ";
    if (dead.isFascist) {
      document.getElementById('powerAction').innerHTML += "FILTHY FASCIST!";
    } else {
      document.getElementById('powerAction').innerHTML += "A BIG LIB!";
    }
    socket.emit('newpres', false);
  });

  socket.on('end', function(game, fasc) {
    if (fasc == 2) {
      document.getElementById('top').innerHTML = game.currChance.name + " is hitler! FASCISTS WIN!";
    } else if (fasc == 1) {
      document.getElementById('top').innerHTML = "FASCISTS WIN!";
    } else if (fasc == 0) {
      document.getElementById('top').innerHTML = "LIBERALS WIN!";
    } else {
      document.getElementById('top').innerHTML = 'The bullet found Hitler! LIBERALS WIN';
    }
    destroyAll();
    document.getElementById('names').innerHTML = "";
    document.getElementById('nameLabel').innerHTML = "";
    var liberals = "";
    var fascists = "";
    for (var i in Object.keys(game.players)) {
      if (game.players[i].isFascist) {
        fascists += game.players[i].name + "<br>";
      } else {
        liberals += game.players[i].name + "<br>";
      }
    }
    document.getElementById('sub').innerHTML = "Fascists: " + fascists + "<br>";
    document.getElementById('sub').innerHTML += 'liberals: ' + liberals + '<br><br><br>';
    document.getElementById('sub').innerHTML += 'please close out this tab and rejoin to start a new game';
  });

  // adds a player to the screen
  socket.on('newPlayer', function(players) {
    var out = "<br>";
    for (var key in players) {
      out += players[key].name + '<br>';
    }
    document.getElementById('names').innerHTML = out;
    document.getElementById('id').innerHTML = players[socket.id].name;

  });

  socket.on('voteTally', function(jas, pres, players, pass) {
    var ja = '';
    var nein = '';
    var i = 0;
    for (var key in jas) {
      if (jas[key]) {
        ja += players[key].name + " ";
      } else {
        nein += players[key].name + " ";
      }
      i++;
    }
    if (pass) {
      document.getElementById('postChoice').innerHTML = 'VOTE PASSED!<br>Sending cards to ' + pres.name + '<br><br>';
      destroyChoice();
      destroyPres();
      if (socket.id == pres.id) {
        socket.emit('presCards');
      }
    } else {
      document.getElementById('postChoice').innerHTML = 'VOTE FAILED!<br>';
    }
    document.getElementById('postChoice').innerHTML += "In favor: " + ja + '<br>Opposed: ' + nein + '<br>';
  });

  socket.on('presCards', function(cards) {
    console.log(cards);
    for (var i = 1; i < cards.length + 1; i++) {
      var x = document.createElement("BUTTON");
      console.log(cards[i-1]);
      const cardButton = cards[i - 1];
      const htIndex = i;
      if (!cards[i - 1]) {
        console.log('fasc');
        var t = document.createTextNode("FASCIST");
        x.addEventListener('click', function() {
          console.log('in event');
          destroySingleCard(htIndex);
          document.getElementById('card' + htIndex).innerHTML = 'Fascist sent';
          socket.emit('presPass', cardButton);
        })
      } else {
        console.log('lib');

        var t = document.createTextNode("LIBERAL");
        x.addEventListener('click', function() {
          console.log('in event');
          destroySingleCard(htIndex);
          document.getElementById('card' + htIndex).innerHTML = 'Liberal sent';
          socket.emit('presPass', cardButton);
        })
      }
      x.append(t);
      var element = document.getElementById('card' + i);
      console.log("card" + i);
      element.append(x);
    }
  });

  socket.on('passing', function(id) {
    destroyPostChoice();
    if (socket.id == id) {
      document.getElementById('postChoice').innerHTML = 'The president just passed you:';
    } else {
      document.getElementById('postChoice').innerHTML = 'Chancellor is deciding on cards';
    }
    destroyCards();
  });

  socket.on('chanceCards', function(cards) {
    for (var i = 1; i < cards.length + 1; i++) {
      var x = document.createElement("BUTTON");
      const cardButton = cards[i-1];
      console.log(cards[i]);
      if (!cards[i - 1]) {
        const htIndex = i;
        var t = document.createTextNode("FASCIST");
        x.addEventListener('click', function() {
          document.getElementById('card' + htIndex).innerHTML = 'Fascist played';
          if (socket.emit('cardPlayed', cardButton)) {
            destroyCards();
          }
        })
      } else {
        const htIndex = i;
        var t = document.createTextNode("LIBERAL");
        x.addEventListener('click', function() {
          document.getElementById('card' + htIndex).innerHTML = 'Liberal played';
          console.log(cardButton);
          if (socket.emit('cardPlayed', cardButton)) {
            destroyCards();
          }
        })
      }
      x.append(t);
      var element = document.getElementById('card' + i);
      element.append(x);
    }
  });

  socket.on('cardPlayed', function(card, game, power) {
    destroyCards();
    document.getElementById('cards').innerHTML = game.currPres.name + " and " + game.currChance.name + " played a ";
    if (card) {
      document.getElementById('cards').innerHTML += 'Liberal card!';
      document.getElementById('l').innerHTML += ' L';
    } else {
      document.getElementById('cards').innerHTML += 'Fascist card!';
      document.getElementById('f').innerHTML += ' F';
    }
    if (socket.id == game.currPres.id && !power) {
      socket.emit('newpres', false);
    }
  });

  socket.on('investigation', function(game) {
    destroyI();
    destroyPostChoice();
    var test = game.currChance.name
    var test2 = game.currPres.name
    document.getElementById('cards').innerHTML = game.currPres.name + " and " + game.currChance.name + " played a ";
    document.getElementById('cards').innerHTML += 'Fascist card!';
    document.getElementById('f').innerHTML += ' F';
    document.getElementById('cards').innerHTML += '<br>' + game.currPres.name + ' now gets an investigation.';
    if (socket.id == game.currPres.id) {
      for (key in game.players) {
        let i = key;
        const id = key;
        if (key != socket.id) {
          var x = document.createElement("BUTTON");
          var t = document.createTextNode(game.players[key].name);
          x.append(t);
          x.addEventListener('click', function() {
            console.log(id);
            investigate(id, game);
          })
          var element = document.getElementById('powerAction');
          element.append(x);
        }
      }
    }
  });

  socket.on('specialElection', function(game) {
    destroyCards();
    destroyPostChoice();
    document.getElementById('cards').innerHTML = game.currPres.name + " and " + game.currChance.name + " played a ";
    document.getElementById('cards').innerHTML += 'Fascist card!';
    document.getElementById('f').innerHTML += ' F';
    document.getElementById('cards').innerHTML += '<br>' + game.currPres.name + ' gets a special election!';
    if (socket.id == game.currPres.id) {
      document.getElementById('choice').innerHTML += '<br>Pick the next president:<br>';
      for (key in game.players) {
        let i = key;
        const id = key;
        if (key != socket.id) {
          var x = document.createElement("BUTTON");
          var t = document.createTextNode(game.players[key].name);
          x.append(t);
          x.addEventListener('click', function() {
            console.log(id);
            elect(id, game);
          })
          var element = document.getElementById('choice');
          element.append(x);
        }
      }
    }
  });

  socket.on('bullet', function(game) {
    destroyPostChoice();
    destroyCards();
    document.getElementById('cards').innerHTML = game.currPres.name + " and " + game.currChance.name + " played a ";
    document.getElementById('cards').innerHTML += 'Fascist card!';
    document.getElementById('f').innerHTML += ' F';
    document.getElementById('choice').innerHTML += '<br>' + game.currPres.name + ' has a bullet...<br>'
    if (socket.id == game.currPres.id) {
      document.getElementById('choice').innerHTML += "Who dies?<br>"
      for (key in game.players) {
        let i = key;
        const id = key;
        if (key == socket.id) {
          continue;
        } else {
          var x = document.createElement("BUTTON");
          var t = document.createTextNode(game.players[key].name);
          x.append(t);
          x.addEventListener('click', function() {
            console.log(id);
            bullet(id);
          })
          var element = document.getElementById('choice');
          element.append(x);
        }
      }
    }
  });

  function bullet(id) {
    socket.emit('bullet', id);
  }

  function elect(id) {
    socket.emit('election', id);
  }

  function chancellor(id, game) {
    if (game.currChance != null && (id == game.currChance.id || id == game.prevPres.id)) {
      console.log(game.currChance.id);
      return;
    }
    socket.emit("chance", id)
    destroyChoice();
  }

  function investigate(id, game) {
    destroyI();
    if (game.players[id].isFascist) {
      document.getElementById('cards').innerHTML = game.players[id].name + " is FASCIST!";
    } else {
      document.getElementById('cards').innerHTML = game.players[id].name + " is LIBERAL!";
    }
    // create continue button
    var x = document.createElement("BUTTON");
    var t = document.createTextNode("Click here when you're ready to continue");
    x.append(t);
    x.addEventListener('click', function() {
      destroyPowerAction();
      socket.emit('newpres', false);
    })
    var element = document.getElementById('powerAction');
    element.append(x);

  }

  function destroySingleCard(i) {
    var parent = document.getElementById('card' + i).parentNode;
    parent.removeChild(document.getElementById('card' + i));
    var newNode = document.createElement('p');
    newNode.setAttribute('id', 'card' + i);
    parent.appendChild(newNode);
  }

  function destroyAll() {
    destroyPostChoice();
    destroyChoice();
    destroyPres();
    destroyCards();
    destroyPowerAction();
  }
  // for getting rid of old buttons and texts that are now unimportant
  function destroyPowerAction() {
    var node = document.getElementById('powerAction');
    var parent = node.parentNode;
    parent.removeChild(node);
    var newNode = document.createElement('h');
    newNode.setAttribute('id', 'powerAction');
    parent.appendChild(newNode);
    return newNode;
  }

  function destroyPostChoice() {
    var node = document.getElementById('postChoice');
    var parent = node.parentNode;
    parent.removeChild(node);
    var newNode = document.createElement('p');
    newNode.setAttribute('id', 'postChoice');
    parent.appendChild(newNode);
    return newNode;
  }

  function destroyChoice() {
    var node = document.getElementById('choice');
    var parent = node.parentNode;
    parent.removeChild(node);
    var newNode = document.createElement('p');
    newNode.setAttribute('id', 'choice');
    parent.appendChild(newNode);
    return newNode;
  }

  function destroyPres() {
    var node = document.getElementById('pres');
    var parent = node.parentNode;
    parent.removeChild(node);
    var newNode = document.createElement('p');
    newNode.setAttribute('id', 'pres');
    parent.appendChild(newNode);
  }

  function destroyCards() {
    var node = document.getElementById('cards');
    var parent = node.parentNode;
    parent.removeChild(node);
    var newNode = document.createElement('h');
    newNode.setAttribute('id', 'cards');
    parent.appendChild(newNode);
    for (var i = 1; i <=3; i++) {
      const index = i;
      var node = document.getElementById('card' + index);
      var parent = node.parentNode;
      console.log(parent);
      parent.removeChild(node);
      var newNode = document.createElement('p');
      newNode.setAttribute('id', 'card' + index);
      console.log(newNode);
      parent.appendChild(newNode);
      console.log(document.getElementById('card'+i));
    }
  }

  function destroyI() {
    var node = document.getElementById('powerAction');
    var parent = node.parentNode;
    parent.removeChild(node);
    var newNode = document.createElement('p');
    newNode.setAttribute('id', 'powerAction');
    parent.appendChild(newNode);
  }

  function gameStart() {
    socket.emit('gamestart');
  }
</script>
